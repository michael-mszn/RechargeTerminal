<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Welcome</title>
  <style>
      body {
          font-family: Arial, sans-serif;
          padding: 2rem;
          text-align: center;
      }

      #welcome {
          font-size: 1.5rem;
          margin-bottom: 1.5rem;
      }

      button {
          padding: 1rem 2rem;
          font-size: 1rem;
          cursor: pointer;
          margin: 0.5rem;
      }

      #result {
          margin-top: 1rem;
          font-weight: bold;
      }

      #status {
          margin-top: 2rem;
          font-size: 1.2rem;
          color: red;
      }

      #charging-time {
          margin-top: 2rem;
          font-size: 1.2rem;
          color: greenyellow;
      }

      #positionOverlay {
          position: fixed;
          inset: 0;
          background: rgba(255, 255, 255, 0.9);
          z-index: 5;
          display: flex;
          flex-direction: column;
          align-items: center;
          justify-content: center;
      }

      #mainUI {
          z-index: 1;
      }

      #disconnectLogout {
          position: fixed;
          top: 1rem;
          right: 1rem;
          display: flex;
          gap: 0.5rem;
          z-index: 1000;
      }

      select {
          font-size: 1rem;
          padding: 0.5rem;
      }

      #positionError {
          color: red;
          margin-top: 1rem;
      }
  </style>
</head>
<body>

<div id="disconnectLogout">
  <button onclick="handleDisconnectClick()">Disconnect</button>
  <button onclick="handleLogoutClick()">Logout</button>
</div>

<!-- Overlay for slot selection -->
<div id="positionOverlay">
  <h2>Bitte wÃ¤hlen Sie Ihre Position</h2>
  <select id="positionSelect">
    <option disabled selected>WÃ¤hle einen freien Slot</option>
  </select>
  <button onclick="submitPosition()">BestÃ¤tigen</button>
  <div id="positionError"></div>
</div>

<div id="welcome">Willkommen, <span id="displayname">...</span>!</div>

<div id="mainUI" style="display: block;">
  <button onclick="incrementCounter()">Recharge</button>
  <textarea id="promptInput" placeholder="Ask Ellioth something ..." rows="4" cols="40"></textarea><br />
  <button onclick="startSpeechRecognition()">ðŸŽ¤ Ask Ellioth something ...</button>
  <button onclick="sendPrompt()">Send</button>
  <div id="result"></div>
  <div id="charging-time"></div>
  <div id="status"></div>
</div>

<script>
  let isValidated = false;
  let isDisconnected = false;

  function fetchCurrentPosition() {
    fetch('https://10.127.0.38/terminalserver/get-current-position.php')
      .then(res => res.json())
      .then(data => {
        if (data.position) {

          isValidated = true;
          document.getElementById('positionOverlay').style.display = 'none';
        } else {
          // No assigned position: show overlay and fetch free slots
          document.getElementById('positionOverlay').style.display = 'flex';
          fetchFreePositions();
        }
      })
      .catch(err => {
        console.error('Fehler beim Abrufen der zugewiesenen Position', err);
        // fallback: show overlay to be safe
        document.getElementById('positionOverlay').style.display = 'flex';
        fetchFreePositions();
      });
  }

  window.onload = () => {
    fetchCurrentPosition();
  }

  function fetchFreePositions() {
    fetch('https://10.127.0.38/terminalserver/get-free-positions.php')
      .then(res => res.json())
      .then(data => {
        const select = document.getElementById('positionSelect');
        data.free_positions.forEach(pos => {
          const option = document.createElement('option');
          option.value = pos;
          option.textContent = `Position ${pos}`;
          select.appendChild(option);
        });
      })
      .catch(err => {
        document.getElementById('positionError').textContent = 'Fehler beim Laden der Positionen.';
        console.error(err);
      });
  }

  function submitPosition() {
    const position = document.getElementById('positionSelect').value;
    if (!position || isNaN(position)) {
      document.getElementById('positionError').textContent = 'Bitte wÃ¤hlen Sie eine gÃ¼ltige Position.';
      return;
    }

    fetch('https://10.127.0.38/terminalserver/claim-position.php', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ position })
    })
      .then(res => res.json())
      .then(data => {
        if (data.status === 'ok') {
          document.getElementById('positionOverlay').style.display = 'none';
          isValidated = true;
        } else {
          document.getElementById('positionError').textContent = data.message || 'Position konnte nicht reserviert werden.';
        }
      })
      .catch(err => {
        console.error(err);
        document.getElementById('positionError').textContent = 'Fehler bei der Anfrage.';
      });
  }

  function handleDisconnectClick() {
    fetch("https://10.127.0.38/terminalserver/disconnect.php")
      .then(res => res.text())
      .then(() => {
        isDisconnected = true;
        document.getElementById("status").textContent = "Sie sind getrennt. Bitte erneut verbinden.";
        document.getElementById("result").textContent = "";
      })
      .catch(err => {
        console.error("Disconnect error:", err);
        document.getElementById("result").textContent = "Fehler beim Trennen.";
      });
  }

  function handleLogoutClick() {
    fetch("https://10.127.0.38/terminalserver/logout.php", {
      method: "POST"
    })
      .then(() => {
        window.location.href = "https://10.127.0.38/terminalserver/ldap.php";
      })
      .catch(() => {
        document.getElementById("result").textContent = "Logout fehlgeschlagen.";
      });
  }

  function notifyIfNotReady() {
    const resultDiv = document.getElementById("result");
    if (isDisconnected) {
      resultDiv.textContent = "Sie sind getrennt. Bitte verbinden Sie sich erneut.";
      return true;
    }
    if (!isValidated) {
      resultDiv.textContent = "Bitte wÃ¤hlen Sie zuerst Ihre Position, um fortzufahren.";
      return true;
    }
    return false;
  }

  function incrementCounter() {
    if (notifyIfNotReady()) return;
    fetch("https://10.127.0.38/terminalserver/increment-counter.php", {
      method: "POST"
    })
      .then(res => res.json())
      .then(data => {
        document.getElementById("result").textContent =
          data.status === "success" ? `ZÃ¤hler: ${data.counter}` : `Fehler: ${data.message}`;
      })
      .catch(() => {
        document.getElementById("result").textContent = "Fehler beim Anfrage senden.";
      });
  }

  function sendPrompt() {
    if (notifyIfNotReady()) return;

    const prompt = document.getElementById("promptInput").value.trim();
    if (!prompt) return;

    fetch("https://10.127.0.38/terminalserver/chatgpt.php", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ prompt }),
    })
      .then(res => res.text())
      .then(text => {
        try {
          const data = JSON.parse(text);
          document.getElementById("result").textContent =
            data.error ? `Fehler: ${data.error}` : "Erfolgreich gesendet.";
        } catch (e) {
          document.getElementById("result").textContent = `UngÃ¼ltige Antwort: ${text}`;
        }
      })
      .catch(err => {
        document.getElementById("result").textContent = `Fehler: ${err.message}`;
      });
  }

  function fetchChargingDuration() {
    fetch('https://10.127.0.38/terminalserver/get-charging-time.php')
      .then(res => res.json())
      .then(data => {
        if (data.status === 'charging') {
          document.getElementById('charging-time').textContent =
            `Charging since ${data.since}`;
        } else {
          document.getElementById('charging-time').textContent = '';
        }
      })
      .catch(err => {
        console.error('Error fetching charging time:', err);
      });
  }

  setInterval(fetchChargingDuration, 60000);
  fetchChargingDuration(); // initial call

  function startSpeechRecognition() {
    if (!('webkitSpeechRecognition' in window || 'SpeechRecognition' in window)) {
      alert('Spracherkennung wird nicht unterstÃ¼tzt.');
      return;
    }

    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    const recognition = new SpeechRecognition();

    recognition.lang = 'de-DE';
    recognition.interimResults = false;
    recognition.maxAlternatives = 1;

    document.getElementById("result").textContent = "HÃ¶re zu... ðŸŽ¤";

    recognition.onresult = function (event) {
      const transcript = event.results[0][0].transcript;
      document.getElementById("promptInput").value = transcript;
      document.getElementById("result").textContent = "Sprache erkannt!";
    };

    recognition.onerror = function (event) {
      document.getElementById("result").textContent = `Fehler: ${event.error}`;
    };

    recognition.onend = function () {
      if (!document.getElementById("promptInput").value) {
        document.getElementById("result").textContent = "Keine Sprache erkannt.";
      }
    };

    recognition.start();
  }

  fetch("https://10.127.0.38/terminalserver/get-name.php")
    .then(res => res.json())
    .then(data => {
      document.getElementById("displayname").textContent = data.name || "Gast";
    })
    .catch(() => {
      document.getElementById("displayname").textContent = "Unbekannt";
    });
</script>

</body>
</html>
