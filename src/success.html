<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Welcome</title>
  <style>
      body {
          font-family: Arial, sans-serif;
          padding: 2rem;
          text-align: center;
      }

      #welcome {
          font-size: 1.5rem;
          margin-bottom: 1.5rem;
      }

      button {
          padding: 1rem 2rem;
          font-size: 1rem;
          cursor: pointer;
          margin: 0.5rem;
      }

      #result {
          margin-top: 1rem;
          font-weight: bold;
      }

      #status {
          margin-top: 2rem;
          font-size: 1.2rem;
          color: red;
      }

      #charging-time {
          margin-top: 2rem;
          font-size: 1.2rem;
          color: greenyellow;
      }

      #positionOverlay {
          position: fixed;
          inset: 0;
          background: rgba(255, 255, 255, 0.9);
          z-index: 5;
          display: flex;
          flex-direction: column;
          align-items: center;
          justify-content: center;
      }

      #mainUI {
          z-index: 1;
      }

      #disconnectLogout {
          position: fixed;
          top: 1rem;
          right: 1rem;
          display: flex;
          gap: 0.5rem;
          z-index: 1000;
      }

      select {
          font-size: 1rem;
          padding: 0.5rem;
      }

      #positionError {
          color: red;
          margin-top: 1rem;
      }
  </style>
</head>
<body>

<div id="disconnectLogout">
  <button onclick="handleDisconnectClick()">Disconnect</button>
  <button onclick="handleLogoutClick()">Logout</button>
</div>

<!-- Overlay for slot selection -->
<div id="positionOverlay">
  <h2>Bitte w√§hlen Sie Ihre Position</h2>
  <select id="positionSelect">
    <option disabled selected>W√§hle einen freien Slot</option>
  </select>
  <button onclick="submitPosition()">Best√§tigen</button>
  <div id="positionError"></div>
</div>

<div id="welcome">Willkommen, <span id="displayname">...</span>!</div>
<div>Kontostand: <span id="balance">0.00</span> ‚Ç¨</div>

<div id="mainUI" style="display: block;">
  <textarea id="promptInput" placeholder="Ask Ellioth something ..." rows="4" cols="40"></textarea><br />
  <button onclick="startSpeechRecognition()">üé§ Ask Ellioth something ...</button>
  <button onclick="sendPrompt()">Send</button>
  <div id="result"></div>
  <div id="charging-time"></div>
  <div id="status"></div>
  <div id="nicenessControl" style="margin-top:2rem; display:none;">
    <label for="nicenessSlider">ü§ù Niceness (0 = selfish, 50% = maximum nice):</label><br>
    <input type="range" id="nicenessSlider" min="0" max="50" value="0" step="1" />
    <span id="nicenessValue">0%</span>
  </div>
</div>

<div id="chargingSessionsContainer" style="margin-top: 2rem;">
  <h3>Vergangene Ladesitzungen</h3>
  <table id="chargingSessionsTable" border="1" style="width: 100%; margin-top: 1rem;">
    <thead>
    <tr>
      <th>kWh</th>
      <th>Kosten (‚Ç¨)</th>
      <th>Startzeit</th>
      <th>Endzeit</th>
      <th>Dauer</th>
    </tr>
    </thead>
    <tbody></tbody>
  </table>
  <div id="paginationControls" style="margin-top: 1rem;"></div>
</div>


<script>
  let isValidated = false;
  let isDisconnected = false;


  function notifyIfNotReady() {
    const resultDiv = document.getElementById("result");
    if (isDisconnected) {
      resultDiv.textContent = "Sie sind getrennt. Bitte verbinden Sie sich erneut.";
      return true;
    }
    if (!isValidated) {
      resultDiv.textContent = "Bitte w√§hlen Sie zuerst Ihre Position, um fortzufahren.";
      return true;
    }
    return false;
  }


  function sendPrompt() {
    if (notifyIfNotReady()) return;

    const prompt = document.getElementById("promptInput").value.trim();
    if (!prompt) return;


  // --- PRELOAD NICENESS FROM SERVER ON PAGE LOAD ---
  let nicenessPreloaded = false;   // true once loaded from DB
  let nicenessUserTouched = false; // prevents overwriting after user moves slider

  function setNicenessUIFromFraction(fraction) {
    // DB stores 0..0.5, slider uses 0..50
    if (typeof fraction !== "number" || isNaN(fraction)) return;
    const percent = Math.round(Math.max(0, Math.min(0.5, fraction)) * 100);
    const slider = document.getElementById("nicenessSlider");
    const label  = document.getElementById("nicenessValue");
    if (!slider || !label) return;
    slider.value = String(percent);
    label.textContent = percent + "%";
  }

  function preloadNicenessFromServer() {
    fetch("https://ellioth.othdb.de/get-current-niceness.php")
      .then(res => res.json())
      .then(data => {
        if (data && data.status === "success" && typeof data.niceness === "number") {
          if (!nicenessUserTouched) {
            setNicenessUIFromFraction(data.niceness);
          }
          nicenessPreloaded = true;
        }
      })
      .catch(err => {
        console.debug("Preload niceness failed:", err);
      });
  }

  // Call once on page load
  preloadNicenessFromServer();

  // --- SLIDER LISTENERS ---
  // Update slider value display
  document.getElementById("nicenessSlider").addEventListener("input", function() {
    document.getElementById("nicenessValue").textContent = this.value + "%";
    nicenessUserTouched = true;
  });

  // Send niceness updates to server
  document.getElementById("nicenessSlider").addEventListener("change", function() {
    const val = parseInt(this.value, 10) / 100; // convert 0‚Äì50 -> 0‚Äì0.5
    fetch("https://ellioth.othdb.de/update-niceness.php", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ niceness: val })
    })
      .then(res => res.json())
      .then(data => {
        if (data.status !== "ok") {
          document.getElementById("status").textContent =
            "Fehler: " + (data.message || "Niceness update fehlgeschlagen.");
        } else {
          updateChargingInfo(); // refresh amperes immediately
        }
      })
      .catch(err => {
        console.error("Niceness error:", err);
        document.getElementById("status").textContent =
          "Fehler beim Senden der Niceness.";
      });
  });

  // --- CHARGING INFO POLLING ---
  function updateChargingInfo() {
    fetch("https://ellioth.othdb.de/get-charging-time.php")
      .then(res => res.json())
      .then(data => {
        if (data.status === "charging") {
          document.getElementById("charging-time").textContent =
            `Charging since ${data.since} (${data.amperes}A)`;
          document.getElementById("nicenessControl").style.display = "block";

          // If niceness not yet loaded, try again when charging is confirmed
          if (!nicenessPreloaded && !nicenessUserTouched) {
            preloadNicenessFromServer();
          }
        } else {
          document.getElementById("charging-time").textContent =
            "Not currently charging.";
          document.getElementById("nicenessControl").style.display = "none";
          // Reset preload flags for next session
          nicenessPreloaded = false;
          nicenessUserTouched = false;
        }
      })
      .catch(err => {
        console.error("Charging info error:", err);
      });
  }

  // Poll every second to catch cars joining/leaving
  setInterval(updateChargingInfo, 1000);
  updateChargingInfo();


  // === Push Notification Setup ===
  // Replace with your actual public key from PHP
  const VAPID_PUBLIC_KEY = 'BNsoK5f2uifDBmBjnUTJrBUGK4U1WLW8mCdfT1yOJu4dLlRDLCvo9wU6XqKuBvSvH1xH2NdtLTcz-BoVCm_EfVw';

  function urlBase64ToUint8Array(base64String) {
    const padding = '='.repeat((4 - base64String.length % 4) % 4);
    const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
    const rawData = atob(base64);
    return Uint8Array.from([...rawData].map(char => char.charCodeAt(0)));
  }

  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
  }

  function subscribeToPush() {
    console.log('[üîî] subscribeToPush() called');
    if (!('serviceWorker' in navigator) || !('PushManager' in window)) {
      console.warn('Push notifications not supported');
      return;
    }

    const rememberToken = getCookie('current_qr_code');
    if (!rememberToken) {
      console.warn('No current_qr_code cookie found');
      return;
    }

    navigator.serviceWorker.register('/sw.js').then(registration => {
      console.log('SW registered:', registration);

      return navigator.serviceWorker.ready;
    }).then(reg => {
      return reg.pushManager.getSubscription()
        .then(sub => {
          if (sub) return sub;

          return reg.pushManager.subscribe({
            userVisibleOnly: true,
            applicationServerKey: urlBase64ToUint8Array(VAPID_PUBLIC_KEY)
          });
        });
    }).then(subscription => {
      // Send to server
      return fetch('/subscribe.php', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          remember_token: getCookie('current_qr_code'),
          subscription: subscription.toJSON()
        })
      });
    }).then(response => {
      if (!response.ok) {
        return response.text().then(text => {
          throw new Error(`Server error: ${response.status} - ${text}`);
        });
      }
      return response.json();
    }).then(data => {
      console.log('Subscribed successfully:', data);
    }).catch(err => {
      console.error('Subscription failed:', err);
    });
  }

  window.addEventListener('load', () => {
    console.log('[üîÑ] Window loaded');

    const rememberToken = getCookie('current_qr_code');
    if (rememberToken) {
      console.log('[üç™] current_qr_code found:', rememberToken);
      subscribeToPush();
    } else {
      console.warn('[‚ö†Ô∏è] current_qr_code cookie NOT found.');
    }
  });


</script>

</body>
</html>
